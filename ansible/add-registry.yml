- name: Configure k3s to trust local registry
  hosts: all
  become: true
  vars:
    registry_host: "{{ lookup('env', 'REGISTRY_HOST') }}"

  tasks:
    - name: Ensure k3s config directory exists
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: "0755"

    - name: Configure insecure registry for containerd (k3s)
      copy:
        dest: /etc/rancher/k3s/registries.yaml
        mode: "0644"
        content: |
          mirrors:
            "{{ registry_host }}":
              endpoint:
                - "http://{{ registry_host }}"

          configs:
            "{{ registry_host }}":
              tls:
                insecure_skip_verify: true
      notify: Restart k3s

  handlers:
    - name: Restart k3s
      service:
        name: "{{ 'k3s' if 'server' in group_names else 'k3s-agent' }}"
        state: restarted
